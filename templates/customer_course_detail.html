{% extends 'base.html' %}
{% block title %}{{ course.title }}{% endblock %}

{% block content %}
<script src="https://js.stripe.com/v3/"></script>

<script>
const stripe = Stripe("{{ stripe_public_key }}"); // pass STRIPE_PUBLIC_KEY into template
function getCookie(name) {
  // small helper to get CSRF cookie
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(function(cookie) {
      const c = cookie.trim();
      if (c.startsWith(name + '=')) cookieValue = decodeURIComponent(c.split('=')[1]);
    });
  }
  return cookieValue;
}

document.getElementById('checkout-button').addEventListener('click', function () {
  const csrftoken = getCookie('csrftoken');
  fetch("{% url 'create_checkout_session' course.id %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
  })
  .then(r => r.json())
  .then(data => stripe.redirectToCheckout({ sessionId: data.id }))
  .catch(e => {
    console.error(e);
    alert('Could not create Stripe session.');
  });
});
</script>
<div id="courses-wrapper">

  <!-- row -->
  <div class="row flex justify-between">


    <!-- single course -->
    <div class="col-md-3 col-sm-6 col-xs-6">
      <div class="course">
        <a href="#" class="course-img">
          <img src="{{ course.image.url }}" alt="">
          <i class="course-link-icon fa fa-link"></i>
        </a>
        <a class="course-title" href="#">{{ course.description }}</a>
        <div class="course-details">
          <span class="course-category">{{ course.title }}</span>
          <span class="course-price course-free">{{ course.course_type }}</span>
        </div>

        {% if course.course_type == 'premium' %}
        <p><b>Price:</b> â‚¹{{ course.price }}</p>
        <form method="post" action="{% url 'create_checkout_session' course.id %}">
          {% csrf_token %}
          <button type="submit">Buy course</button>
        </form>
        {% else %}
        <p>ðŸ†“ Free Course</p>
        {% endif %}
      </div>

    </div>

    <!-- RIGHT SIDE : Enroll Card -->
    <div class="col-md-4">
      <div class="course-enroll-card">
        <h3>
          {% if course.course_type == "free" %}
          FREE
          {% else %}
          PREMIUM
          {% endif %}
        </h3>

        <hr>

        <ul class="list-unstyled">
          <li>âœ” Full Lifetime Access</li>
          <li>âœ” Certificate Included</li>
          <li>âœ” Mobile & Desktop</li>
        </ul>

        <button class="btn btn-success btn-block btn-lg">
          <a href="{% url 'enroll_course' course.id %}">Enroll Now</a>
        </button>
      </div>
    </div>

  </div>
</div>


</div>


</div>
{% endblock %}
<script>
document.getElementById("payBtn").addEventListener("click", function(){
  fetch("/create-checkout-session/12/")
  .then(res => res.json())
  .then(data => {
    window.location.href = data.url;   // <-- Stripe page open
  });
});
</script>